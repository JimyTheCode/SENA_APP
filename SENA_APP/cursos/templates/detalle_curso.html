{% extends "master.html" %}
{% load static %}

{% block title %}Detalles del Curso{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'detalles.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="container my-5">
  <div class="card card-sena">
    <div class="header">
      <i class="bi bi-journal-bookmark-fill" style="font-size:1.6rem"></i>
      <div>
        <h2>Detalles del Curso</h2>
      </div>
      <div style="margin-left:auto" class="small">Código: <strong>{{ curso.codigo }}</strong></div>
    </div>

    <div class="profile">
      <div class="avatar" style="font-size:1.5rem;">
        {{ curso.codigo|slice:":2" }}
      </div>

      <div class="info-summary">
        <div class="name">{{ curso.nombre }}</div>
        {% if curso.estado == 'PRO' %}
          <div class="badge" style="background: #6c757d; color:white; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-clock"></i> Programado
          </div>
        {% elif curso.estado == 'INI' %}
          <div class="badge" style="background: #0dcaf0; color:white; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-play-circle"></i> Iniciado
          </div>
        {% elif curso.estado == 'EJE' %}
          <div class="badge" style="background: linear-gradient(135deg,#39A900,#2d8000); color:white; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-lightning-charge"></i> En Ejecución
          </div>
        {% elif curso.estado == 'FIN' %}
          <div class="badge" style="background: #198754; color:white; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-check-circle"></i> Finalizado
          </div>
        {% elif curso.estado == 'CAN' %}
          <div class="badge" style="background: #dc3545; color:white; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-x-circle"></i> Cancelado
          </div>
        {% elif curso.estado == 'SUS' %}
          <div class="badge" style="background: #ffc107; color:#000; padding:0.4rem 1rem; border-radius:20px; display:inline-block; margin-top:0.5rem;">
            <i class="bi bi-pause-circle"></i> Suspendido
          </div>
        {% endif %}
      </div>
    </div>

    <div class="content-grid">
      <div class="row-item">
        <div class="icon"><i class="bi bi-upc-scan"></i></div>
        <div>
          <div class="label">Código del Curso</div>
          <div class="value">{{ curso.codigo }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-book-fill"></i></div>
        <div>
          <div class="label">Programa de Formación</div>
          <div class="value">{{ curso.programa.nombre }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-person-badge"></i></div>
        <div>
          <div class="label">Instructor Coordinador</div>
          <div class="value">
            {% if curso.instructor_coordinador %}
              <a href="{% url 'detalle_instructor' curso.instructor_coordinador.id %}" style="color:#39A900; text-decoration:none;">
                {{ curso.instructor_coordinador.nombre }} {{ curso.instructor_coordinador.apellido }}
              </a>
            {% else %}
              <span class="text-muted">No asignado</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-calendar-event"></i></div>
        <div>
          <div class="label">Fecha de Inicio</div>
          <div class="value">{{ curso.fecha_inicio|date:"d F, Y" }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-calendar-check"></i></div>
        <div>
          <div class="label">Fecha de Finalización</div>
          <div class="value">{{ curso.fecha_fin|date:"d F, Y" }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-clock"></i></div>
        <div>
          <div class="label">Horario</div>
          <div class="value">{{ curso.horario }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-door-open"></i></div>
        <div>
          <div class="label">Aula / Ambiente</div>
          <div class="value">{{ curso.aula }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-people-fill"></i></div>
        <div>
          <div class="label">Cupos Máximos</div>
          <div class="value">{{ curso.cupos_maximos }} cupos</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-person-check"></i></div>
        <div>
          <div class="label">Cupos Ocupados</div>
          <div class="value">{{ curso.aprendices.count }} aprendiz{{ curso.aprendices.count|pluralize:"es" }}</div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-person-plus"></i></div>
        <div>
          <div class="label">Cupos Disponibles</div>
          <div class="value">
            {% with disponibles=curso.cupos_disponibles %}
              {% if disponibles > 0 %}
                <span style="color:#39A900; font-weight:600;">{{ disponibles }} disponible{{ disponibles|pluralize:"s" }}</span>
              {% else %}
                <span style="color:#dc3545; font-weight:600;">Sin cupos</span>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-bar-chart-fill"></i></div>
        <div>
          <div class="label">Porcentaje de Ocupación</div>
          <div class="value">
            {% with ocupacion=curso.porcentaje_ocupacion %}
              <div style="display:flex; align-items:center; gap:0.75rem;">
                <span style="font-weight:600;">{{ ocupacion|floatformat:1 }}%</span>
                <div class="progress" style="flex:1; height:10px; background:#e9ecef; border-radius:5px; overflow:hidden;">
                  {% if ocupacion >= 90 %}
                    <div style="width:{{ ocupacion }}%; height:100%; background:#dc3545; transition:width 0.3s;"></div>
                  {% elif ocupacion >= 70 %}
                    <div style="width:{{ ocupacion }}%; height:100%; background:#ffc107; transition:width 0.3s;"></div>
                  {% else %}
                    <div style="width:{{ ocupacion }}%; height:100%; background:linear-gradient(135deg,#39A900,#2d8000); transition:width 0.3s;"></div>
                  {% endif %}
                </div>
              </div>
            {% endwith %}
          </div>
        </div>
      </div>

      <div class="row-item">
        <div class="icon"><i class="bi bi-calendar-plus"></i></div>
        <div>
          <div class="label">Fecha de Registro en Sistema</div>
          <div class="value">{{ curso.fecha_registro|date:"d F, Y - H:i" }}</div>
        </div>
      </div>

      {% if curso.observaciones %}
      <div class="row-item" style="grid-column: 1 / -1;">
        <div class="icon"><i class="bi bi-chat-square-text"></i></div>
        <div>
          <div class="label">Observaciones</div>
          <div class="value" style="line-height:1.6;">{{ curso.observaciones }}</div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sección de Instructores Asignados -->
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e9ecef;">
      <h5 style="color:#2d8000; margin-bottom:1rem;">
        <i class="bi bi-people"></i> Instructores Asignados ({{ curso.instructorcurso_set.count }})
      </h5>
      {% if curso.instructorcurso_set.exists %}
        <div style="display:grid; gap:0.75rem;">
          {% for ic in curso.instructorcurso_set.all %}
            <div style="display:flex; align-items:center; gap:1rem; padding:0.75rem; background:#f8f9fa; border-radius:8px;">
              <div style="width:40px;height:40px;border-radius:50%;background:#e8f5e0;color:#2d8000;display:flex;align-items:center;justify-content:center;font-weight:700;">
                {{ ic.instructor.nombre|slice:":1" }}{{ ic.instructor.apellido|slice:":1" }}
              </div>
              <div style="flex:1;">
                <div style="font-weight:600;">{{ ic.instructor.nombre }} {{ ic.instructor.apellido }}</div>
                <small class="text-muted">{{ ic.rol }}</small>
              </div>
              <small class="text-muted">Asignado: {{ ic.fecha_asignacion|date:"d/m/Y" }}</small>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted"><i class="bi bi-info-circle"></i> No hay instructores adicionales asignados.</p>
      {% endif %}
    </div>

    <!-- Sección de Aprendices Inscritos -->
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e9ecef;">
      <h5 style="color:#2d8000; margin-bottom:1rem;">
        <i class="bi bi-mortarboard"></i> Aprendices Inscritos ({{ curso.aprendizcurso_set.count }})
      </h5>
      {% if curso.aprendizcurso_set.exists %}
        <div class="table-responsive">
          <table class="table table-hover" style="font-size:0.9rem;">
            <thead style="background:#f8f9fa;">
              <tr>
                <th>Aprendiz</th>
                <th>Estado</th>
                <th>Fecha Inscripción</th>
                <th>Nota Final</th>
              </tr>
            </thead>
            <tbody>
              {% for ac in curso.aprendizcurso_set.all %}
                <tr>
                  <td>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                      <div style="width:30px;height:30px;border-radius:50%;background:#e8f5e0;color:#2d8000;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;">
                        {{ ac.aprendiz.nombre|slice:":1" }}{{ ac.aprendiz.apellido|slice:":1" }}
                      </div>
                      <span>{{ ac.aprendiz.nombre }} {{ ac.aprendiz.apellido }}</span>
                    </div>
                  </td>
                  <td>
                    {% if ac.estado == 'INS' %}
                      <span class="badge bg-secondary">Inscrito</span>
                    {% elif ac.estado == 'ACT' %}
                      <span class="badge" style="background:#39A900;">Activo</span>
                    {% elif ac.estado == 'DES' %}
                      <span class="badge bg-warning text-dark">Desertor</span>
                    {% elif ac.estado == 'GRA' %}
                      <span class="badge bg-success">Graduado</span>
                    {% elif ac.estado == 'SUS' %}
                      <span class="badge bg-danger">Suspendido</span>
                    {% endif %}
                  </td>
                  <td>{{ ac.fecha_inscripcion|date:"d/m/Y" }}</td>
                  <td>
                    {% if ac.nota_final %}
                      <strong>{{ ac.nota_final }}</strong>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted"><i class="bi bi-info-circle"></i> No hay aprendices inscritos en este curso.</p>
      {% endif %}
    </div>

    <div class="actions">
      <a href="{% url 'cursos:lista_cursos' %}" class="btn-sena">
        <i class="bi bi-arrow-left-circle"></i> Volver al Listado
      </a>
    </div>
  </div>
</div>

{% endblock %}